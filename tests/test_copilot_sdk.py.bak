"""Tests for copilot_sdk.py module (direct SDK integration)."""

import pytest
import subprocess
from unittest.mock import patch, MagicMock, AsyncMock
from pathlib import Path

from pokepoke.copilot import get_allowed_directories
from pokepoke.copilot_sdk import (
    build_prompt_from_work_item,
    invoke_copilot_sdk,
    invoke_copilot_sdk_sync
)
from pokepoke.types import BeadsWorkItem


@pytest.fixture
def sample_work_item():
    """Create a sample work item for testing."""
    return BeadsWorkItem(
        id="test-123",
        title="Test work item",
        description="Test description",
        status="in_progress",
        priority=1,
        issue_type="task",
        labels=["testing", "coverage"]
    )


class TestGetAllowedDirectoriesSDK:
    """Tests for get_allowed_directories function in SDK module."""
    
    @patch('pokepoke.copilot.subprocess.run')
    @patch('pokepoke.copilot.os.getcwd')
    def test_allowed_directories_with_git(self, mock_getcwd, mock_run):
        """Test allowed directories when git command succeeds."""
        mock_getcwd.return_value = "/current/dir"
        mock_run.return_value = MagicMock(
            stdout=".git\n",
            returncode=0
        )
        
        result = get_allowed_directories()
        
        assert "/current/dir" in result
        assert len(result) >= 1
    
    @patch('pokepoke.copilot.subprocess.run')
    @patch('pokepoke.copilot.os.getcwd')
    def test_allowed_directories_git_fails(self, mock_getcwd, mock_run):
        """Test allowed directories when git command fails."""
        mock_getcwd.return_value = "/current/dir"
        mock_run.side_effect = subprocess.CalledProcessError(1, "git")
        
        result = get_allowed_directories()
        
        # Should still return current directory
        assert result == ["/current/dir"]
    
    @patch('pokepoke.copilot.subprocess.run')
    @patch('pokepoke.copilot.os.getcwd')
    def test_allowed_directories_different_root(self, mock_getcwd, mock_run):
        """Test when worktree directory differs from repo root."""
        mock_getcwd.return_value = "/worktree/dir"
        mock_run.return_value = MagicMock(
            stdout="/repo/.git\n",
            returncode=0
        )
        
        result = get_allowed_directories()
        
        # Should contain both worktree and repo root
        assert "/worktree/dir" in result


class TestBuildPromptFromWorkItem:
    """Tests for build_prompt_from_work_item function."""
    
    @patch('pokepoke.copilot_sdk.PromptService')
    def test_build_prompt_from_work_item(self, mock_service_class, sample_work_item):
        """Test building prompt from work item."""
        mock_service = MagicMock()
        mock_service.load_and_render.return_value = "Rendered prompt"
        mock_service_class.return_value = mock_service
        
        result = build_prompt_from_work_item(sample_work_item)
        
        assert result == "Rendered prompt"
        mock_service.load_and_render.assert_called_once()
        call_args = mock_service.load_and_render.call_args
        assert call_args[0][0] == "beads-item"
        variables = call_args[0][1]
        assert variables["item_id"] == "test-123"
        assert variables["title"] == "Test work item"
    
    @patch('pokepoke.copilot_sdk.PromptService')
    def test_build_prompt_without_labels(self, mock_service_class):
        """Test building prompt for work item without labels."""
        mock_service = MagicMock()
        mock_service.load_and_render.return_value = "Prompt"
        mock_service_class.return_value = mock_service
        
        work_item = BeadsWorkItem(
            id="test-456",
            title="No labels",
            description="Test",
            status="open",
            priority=2,
            issue_type="bug",
            labels=None
        )
        
        result = build_prompt_from_work_item(work_item)
        
        assert result == "Prompt"
        call_args = mock_service.load_and_render.call_args
        variables = call_args[0][1]
        assert variables["labels"] is None

class TestInvokeCopilotSDK:
    """Tests for invoke_copilot_sdk and invoke_copilot_sdk_sync functions."""
    
    @pytest.mark.asyncio
    @patch('pokepoke.copilot_sdk.CopilotClient')
    @patch('pokepoke.copilot_sdk.build_prompt_from_work_item')
    async def test_invoke_copilot_sdk_with_item_logger(
        self, mock_build_prompt, mock_client_class, sample_work_item
    ):
        """Test that invoke_copilot_sdk accepts item_logger parameter."""
        mock_build_prompt.return_value = "Test prompt"
        mock_client = AsyncMock()
        mock_session = AsyncMock()
        mock_session.session_id = "test-session"
        mock_client.create_session = AsyncMock(return_value=mock_session)
        mock_client_class.return_value = mock_client
        
        # Mock the session to immediately complete
        async def mock_send_prompt(*args, **kwargs):
            # Trigger completion event
            done_event = kwargs.get('on_event')
            if done_event:
                # Create a mock completion event
                event = MagicMock()
                event.type.value = "assistant.message"
                event.data.content = "Test output"
                done_event(event)
        
        mock_session.send_prompt = mock_send_prompt
        
        # Create a mock logger
        mock_logger = MagicMock()
        
        # Call the function with item_logger parameter
        result = await invoke_copilot_sdk(
            work_item=sample_work_item,
            item_logger=mock_logger
        )
        
        # Verify function accepts the parameter and runs
        assert mock_build_prompt.called
    
    @patch('pokepoke.copilot_sdk.asyncio.run')
    @patch('pokepoke.copilot_sdk.build_prompt_from_work_item')
    def test_invoke_copilot_sdk_sync_with_item_logger(
        self, mock_build_prompt, mock_asyncio_run, sample_work_item
    ):
        """Test that invoke_copilot_sdk_sync accepts item_logger parameter."""
        mock_build_prompt.return_value = "Test prompt"
        mock_asyncio_run.return_value = MagicMock(
            success=True,
            output="Test output"
        )
        
        # Create a mock logger
        mock_logger = MagicMock()
        
        # Call the function with item_logger parameter
        result = invoke_copilot_sdk_sync(
            work_item=sample_work_item,
            item_logger=mock_logger
        )
        
        # Verify function accepts the parameter
        assert mock_asyncio_run.called
        # Verify item_logger was passed through to async function
        call_kwargs = mock_asyncio_run.call_args[0][0].__name__
        assert call_kwargs == 'invoke_copilot_sdk'